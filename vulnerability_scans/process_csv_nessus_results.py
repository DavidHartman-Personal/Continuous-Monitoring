import csv
import os
import datetime
import sys

ENVIRONMENT = "L5"
YEAR_MONTH_DAY = datetime.datetime.now().strftime("%Y%m%d")

FEDRAMP_DIR = "C:\\Users\\dhartman\\Documents\\FedRAMP\\Continuous " \
              "Monitoring\\Vulnerability-Scanning\\{environment}\\07 - Jul\\".format(environment=ENVIRONMENT)
# RAW_NESSUS_FOLDER = "06282020-Nessus-Raw\\"
# RAW_NESSUS_FOLDER_PATH = os.path.join(FEDRAMP_DIR,RAW_NESSUS_FOLDER)

CSV_IN_FILE = os.path.join(FEDRAMP_DIR, "All-vulnerabilities-07072020.csv")



if __name__ == "__main__":
    maxInt = sys.maxsize

    while True:
        # decrease the maxInt value by factor 10
        # as long as the OverflowError occurs.

        try:
            csv.field_size_limit(maxInt)
            break
        except OverflowError:
            maxInt = int(maxInt / 10)

    severity_count = {}
    try:
        with open(CSV_IN_FILE) as file_handle:
            # csv.field_size_limit(sys.maxsize)
            csv_reader = csv.DictReader(file_handle, skipinitialspace=True)
            for line in csv_reader:
                if line['Severity'] in severity_count:
                    severity_count[line['Severity']] = severity_count[line['Severity']] + 1
                else:
                    severity_count[line['Severity']] = 0
                if line['Plugin'] == "133483":
                    print("{server} ({ip})".format(server=line['DNS Name'],ip=str(line['IP Address']),))
                    # print(str(line))
            print(str(severity_count))

    except Exception as e:
        print("Error in opening/processing file [{file}]: {exception}".format(file='test.csv',
                                                                              exception=str(e)))