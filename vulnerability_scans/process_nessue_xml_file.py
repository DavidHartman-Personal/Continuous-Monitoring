"""Script to process .nessus files

Inputs
- Nessue file

Outputs
- TBD


"""
import logging
import os
import re
import openpyxl
import datetime
import json
import xml.dom.minidom as minidom
import xml.etree.ElementTree as element_tree

ENVIRONMENT = "L5"
YEAR_MONTH_DAY = datetime.datetime.now().strftime("%Y%m%d")

FEDRAMP_DIR = "C:\\Users\\dhartman\\Documents\\FedRAMP\\Continuous " \
              "Monitoring\\Vulnerability-Scanning\\{environment}\\06 - Jun\\".format(environment=ENVIRONMENT)
RAW_NESSUS_FOLDER = "06282020-Nessus-Raw\\"
RAW_NESSUS_FOLDER_PATH = os.path.join(FEDRAMP_DIR,RAW_NESSUS_FOLDER)

XML_IN_FILE = os.path.join(FEDRAMP_DIR, "12445.nessus")



def get_scan_name_targets(in_nessus_file):
    dom_parser = minidom.parse(in_nessus_file)
    policies = dom_parser.getElementsByTagName("policyName")
    policy_name = policies[0].firstChild.data
    scan_name_elements = dom_parser.getElementsByTagName("Report")
    scan_name = scan_name_elements[0].attributes['name'].value
    preference_elements = dom_parser.getElementsByTagName("preference")
    # each preference has a name node and a value node
    # <preference>
    #   <name>max_simult_tcp_sessions</name>
    #   <value></value>
    # </preference>
    # build a bash with the key being the name and the value being the values
    pref_dict = {}
    pref_dict['POLICY_NAME'] = policy_name
    pref_dict['SCAN_NAME'] = scan_name
    for pref in preference_elements:
        name = pref.getElementsByTagName('name')[0].childNodes[0].data
        value_node = pref.getElementsByTagName('value')[0]
        value_len = value_node.childNodes.length
        if (value_len > 0):
            value = value_node.childNodes[0].data
        else:
            value = ""
        if name == 'TARGET':
            pref_dict[name] = value.split(",")
        else:
            pref_dict[name] = value
    return pref_dict

    # print(str(pref_dict))
#    targets = pref_dict['TARGET'].split(",")
 #   print(str(targets))
    # print("Targets: " + pref_dict['TARGET'])

    # print("policy name: " + str(policy_name))
    #print("report/scan name: " + str(scan_name))

if __name__ == "__main__":
    nessus_file_prefs = {}
    for file in os.listdir(RAW_NESSUS_FOLDER_PATH):
        if file.endswith(".nessus"):
            nessus_file_full_path = os.path.join(RAW_NESSUS_FOLDER_PATH,file)
            nessus_file_prefs[file] = get_scan_name_targets(nessus_file_full_path)
            for target in nessus_file_prefs[file]['TARGET']:
                # print("Name: " + str(nessus_file_prefs[file]['SCAN_NAME']) +
                #   " Policy: " + str(nessus_file_prefs[file]['POLICY_NAME']) +
                #   " Targets: " + str(target))
                print(str(file) + "\t" +
                      str(nessus_file_prefs[file]['SCAN_NAME']) + "\t" +
                      str(nessus_file_prefs[file]['POLICY_NAME']) + "\t" +
                      str(target))