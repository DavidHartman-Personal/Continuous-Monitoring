"""Copies the Nessus Scan Name, Policy, Credentials and individual targets to the clipboard
"""
import logging
import os
import re

import coloredlogs
import openpyxl
import json
import datetime
import pandas

# Variable/constant declarations

FIRST_DATA_ROW = 2
ENVIRONMENT = "L5"
YEAR_MONTH_DAY = datetime.datetime.now().strftime("%Y%m%d")
# 3 character month abbreviation
MONTH_ABBREV = datetime.datetime.now().strftime("%b")
# Month number
MONTH_NUM = datetime.datetime.now().strftime("%m")

# C:\Users\dhartman\Documents\FedRAMP\Continuous Monitoring\Vulnerability-Scanning\L5\05 - MAY\PTC_L5_Weekly_Scan_Review_05312020.xlsx
FEDRAMP_DIR = "C:\\Users\\dhartman\\Documents\\FedRAMP\\CMDB\\{environment}\\".format(environment=ENVIRONMENT)
SCAN_JOB_TARGETS = "CMDB-{environment}-Master.xlsx".format(environment=ENVIRONMENT)
SCAN_TARGET_POLICY_SHEET = "all_scans_policies_targets"
SCAN_POLICY_TARGET_FULL_PATH = os.path.join(FEDRAMP_DIR, SCAN_JOB_TARGETS)
logging_level = 'INFO'
coloredlogs.install(level=logging_level,
                    fmt="%(asctime)s %(hostname)s %(name)s %(filename)s line-%(lineno)d %(levelname)s - %(message)s",
                    datefmt='%H:%M:%S')
def datetime_default(obj):
    if isinstance(obj, (datetime.date, datetime.datetime)):
        return obj.isoformat()

SCAN_POLICY_TARGET = ["SCAN_NAME",
                      "POLICY_NAME",
                      "CREDENTIALS",
                      "TARGETS"]

if __name__ == "__main__":
    logging.debug("Processing scan, target, policy excel [%s]", SCAN_POLICY_TARGET_FULL_PATH)
    scan_policy_target_wb = openpyxl.load_workbook(SCAN_POLICY_TARGET_FULL_PATH)
    scan_policy_target_ws = scan_policy_target_wb[SCAN_TARGET_POLICY_SHEET]
    line_number = 0
    scan_target = []
    for row in scan_policy_target_ws.iter_rows(min_row=2, max_col=100, values_only=True):
        if row[SCAN_POLICY_TARGET.index('SCAN_NAME')] is None:
            continue
        line_number += 1

        stripped_scan_result_row = [field.strip() if type(field) == str else str(field) for field in row]

        scan_name = stripped_scan_result_row[SCAN_POLICY_TARGET.index('SCAN_NAME')]
        policy_name = stripped_scan_result_row[SCAN_POLICY_TARGET.index('POLICY_NAME')]
        credentials = stripped_scan_result_row[SCAN_POLICY_TARGET.index('CREDENTIALS')]
        target_list = stripped_scan_result_row[SCAN_POLICY_TARGET.index('TARGETS')]
        targets = [item.strip() for item in target_list.split(',')]
        for target in targets:
            scan_target.append([scan_name,policy_name, credentials, target])
        # print(str(scan_target))
        df = pandas.DataFrame(scan_target)
        df.to_clipboard(index=False, header=False)